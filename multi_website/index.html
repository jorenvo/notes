<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2020-05-14 Thu 16:20 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Multi-website in Odoo v12</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Joren Van Onder">
<meta name="description" content="NAT traversal"
>
<link rel="stylesheet" type="text/css" href="/notes/revisioned/assets/style-71440a4164.css"/>
<link rel="icon" href="/notes/revisioned/assets/favicon-034aad3767.png" type="image/x-icon"/>
<script src="/notes/revisioned/assets/sw-loader-649419f22f.js" defer></script>
</head>
<body>
<div id="preamble" class="status">

<div class="top">
  <a href="/notes/">notes</a> / multi website
  <div class="contact">
      github:&nbsp;<a href="https://github.com/jorenvo">jorenvo</a> |
      email:&nbsp;<a href="mailto:joren@jvo.sh">joren@jvo.sh</a> |
      PGP:&nbsp;<a href="/publickey.txt">50A5 7A39 0DE1 1A6C</a> |
      keybase:&nbsp;<a href="https://keybase.io/jvo">jvo</a>
  </div>
</div>
</div>
<div id="content">
<header>
<h1 class="title">Multi-website in Odoo v12</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org6ee3247">1. Multi-website</a>
<ul>
<li><a href="#org4141e76">1.1. Basics</a>
<ul>
<li><a href="#org9d15cea">1.1.1. Session</a></li>
<li><a href="#orgc4ae07e">1.1.2. Assets</a></li>
<li><a href="#org58da98a">1.1.3. Themes (TODO)</a></li>
</ul>
</li>
<li><a href="#org5b08aa4">1.2. Website Selection</a>
<ul>
<li><a href="#org389772c">1.2.1. Forced</a></li>
<li><a href="#orgff57116">1.2.2. Normal</a></li>
</ul>
</li>
<li><a href="#org8be7c1a">1.3. Copy-on-write (COW)</a></li>
<li><a href="#org41ff0bf">1.4. Mixins</a>
<ul>
<li><a href="#orgfa94413">1.4.1. website.published.multi.mixin</a></li>
<li><a href="#org549e86d">1.4.2. website.published.mixin</a></li>
<li><a href="#org298924a">1.4.3. website.multi.mixin</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</nav>
<div id="outline-container-org6ee3247" class="outline-2">
<h2 id="org6ee3247"><span class="section-number-2">1</span> Multi-website</h2>
<div class="outline-text-2" id="text-1">
<p>
The goal of this document is to give a thorough technical
understanding of the standard multi-website feature in â‰¥v12. I will be
focusing on v12 in this document, but everything should be applicable
to v13 as well.
</p>
</div>

<div id="outline-container-org4141e76" class="outline-3">
<h3 id="org4141e76"><span class="section-number-3">1.1</span> Basics</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org9d15cea" class="outline-4">
<h4 id="org9d15cea"><span class="section-number-4">1.1.1</span> Session</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Sessions are based on <a href="https://werkzeug.palletsprojects.com/en/0.16.x/contrib/sessions/">Werkzeug sessions</a>. When a user visits Odoo a
session cookie is created and stored in their browser. It's a unique
ID that links every requests that browser makes to a session in
Odoo. The session is persistent and is written to disk (by default
<code>~/.local/share/Odoo/sessions/</code>). This contains data that needs to
persist (e.g. whether or not the user is logged in). The session files
are pickled, if you want to inspect them use:
</p>

<pre class="example">
$ python3 -m pickle ~/.local/share/Odoo/sessions/werkzeug_861d25cbe84e9841b907cad27bcca6dae543400d.sess
</pre>

<p>
Stale sessions are automatically removed. A session is considered
stale if it hasn't been modified for one week. The expiration date for
the cookie on the browser side is 3 months. This is why after 3 months
you need to login again.
</p>
</div>
</div>

<div id="outline-container-orgc4ae07e" class="outline-4">
<h4 id="orgc4ae07e"><span class="section-number-4">1.1.2</span> Assets</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
JS and SCSS assets in Odoo are compiled, minimized and combined into
asset bundles. In the case of SCSS it's a necessary step; it needs to
be compiled to CSS for the browser to understand. But this is not the
only reason, reducing the number of files the browser needs to load
also reduces the amount of HTTP requests. On top of that the
minimization reduces the filesize which speeds up each HTTP
request. To skip the minimization and bundling you can use
<code>?debug=assets</code>. It's useful when working on the frontend and also
demonstrates how much faster the asset bundling process makes Odoo.
</p>

<p>
Each bundle is a single file, saved as an <code>ir.attachment</code> record. You
can find them like this:
</p>

<pre class="example">
SELECT id, url
FROM ir_attachment
WHERE name LIKE '/web/content%'
ORDER BY id;
</pre>

<p>
New bundles are defined in templates as regular QWEB templates and
called in the appropriate locations as follows:
</p>

<pre class="example">
&lt;t t-call-assets="web.assets_common"...
</pre>

<p>
This leads to <code>_get_asset_nodes</code> being called which eventually calls
<code>get_asset_bundle</code>. This creates objects that inherit from
<code>AssetsBundle</code> (like <code>JavascriptAsset</code> and <code>StylesheetAsset</code>). The
unique key of the asset is computed in the <code>checksum</code> property and is
a hash of:
</p>

<ul class="org-ul">
<li>the metadata of the files (filename, type, url, &#x2026;) it contains, and</li>
<li>the last time a file in the asset bundle was modified</li>
</ul>

<p>
This causes recompilation of an asset bundle when a file in it changes
or new files are added. This checksum is saved in the URL of the
<code>ir.attachment</code> and looks like this:
</p>

<p>
<code>/web/content/1002-0d0afe0/web.assets_common.js</code>
</p>

<dl class="org-dl">
<dt><code>1002</code></dt><dd>the <code>ir.attachment</code> ID</dd>
<dt><code>0d0afe0</code></dt><dd>the first 7 characters of the <code>checksum</code></dd>
</dl>

<p>
This leads to issues with &gt;1 website, because every website will have
its own assets. To avoid the assets constantly recompiling the
<code>website</code> module adds the website ID to the URL:
</p>

<p>
<code>/web/content/1012-0d0afe0/2/web.assets_common.0.js</code>
</p>

<dl class="org-dl">
<dt><code>2</code></dt><dd>the website ID</dd>
</dl>

<p>
This allows Odoo to maintain separate compiled asset bundles per
website.
</p>
</div>
</div>
<div id="outline-container-org58da98a" class="outline-4">
<h4 id="org58da98a"><span class="section-number-4">1.1.3</span> Themes (TODO)</h4>
</div>
</div>

<div id="outline-container-org5b08aa4" class="outline-3">
<h3 id="org5b08aa4"><span class="section-number-3">1.2</span> Website Selection</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org389772c" class="outline-4">
<h4 id="org389772c"><span class="section-number-4">1.2.1</span> Forced</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
You can force Odoo to load a specific website ID with a GET parameter,
like is done by the website switcher:
</p>

<pre class="example">
?fw=2
</pre>

<p>
This is set on the session, so it will persist for as long as the user
is logged in.
</p>
</div>
</div>
<div id="outline-container-orgff57116" class="outline-4">
<h4 id="orgff57116"><span class="section-number-4">1.2.2</span> Normal</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
To figure out what website you're on always use
<code>self.env["website"].get_current_website()</code>. There's a lot of cases
that are handled by it (fw= overrides, geoip, domain names, &#x2026;).
</p>
</div>
</div>
</div>

<div id="outline-container-org8be7c1a" class="outline-3">
<h3 id="org8be7c1a"><span class="section-number-3">1.3</span> Copy-on-write (COW)</h3>
<div class="outline-text-3" id="text-1-3">
<p>
Multi-website was implemented in a way that keeps module upgrades and
migrations easy. What do we do when a bugfix in a view was merged? It
needs to ensure this view change is applied to all websites. It also
makes sure that we retain the ability for a user to create a brand
new, unmodified website at all times (with e.g. an unmodified Contact
Us page). When naively duplicating views for each website you clutter
the database with a lot of unnecessary records.
</p>

<p>
In most cases Odoo will use a <a href="https://en.wikipedia.org/wiki/Copy-on-write">copy-on-write</a> mechanism. It defers
duplicating views until necessary. Views are created without a
<code>website_id</code> and rendered as usual. When a user modifies it a website
specific copy is created with the appropriate <code>website_id</code> and the
same <code>key</code>. This only happens for writes that happen via the frontend
(not in /web). With this mechanism bugfixes to non-edited views are
applied as usual and newly created websites will contain all the
necessary views.
</p>

<p>
From a technical POV this is mostly implemented in the <code>write</code> of
<code>ir.ui.view</code> in the website module, note that it will also handle:
</p>

<ul class="org-ul">
<li>creating website-specific inherited views if they exist,</li>
<li>creating website-specific inactive views (TODO options website),</li>
<li>creating website-specific pages for these views,</li>
</ul>

<p>
Also this way new websites contain default views.
</p>

<p>
THis means that it's possible there are multiple views with the same
XML ID. Since this isn't possible we instead use the <code>key</code> field as
identifiers for the views.
</p>

<p>
For unlinking a Copy-on-unlink <a href="https://github.com/odoo/odoo/blob/dd40fb63b4ebdd4dd7b44c75d415e99b52d633a1/addons/website/models/ir_ui_view.py#L161">is implemented</a>. Website-specific copies
are created when a generic view is deleted from the frontend.
</p>

<p>
On top of this there is a mechanism that duplicates writes during
module updates. It's implemented in <a href="https://github.com/odoo/odoo/blob/dd40fb63b4ebdd4dd7b44c75d415e99b52d633a1/addons/website/models/ir_ui_view.py#L126">_load_records_write()</a>. During a
module upgrade it will duplicate writes on views to website-specific
views. This only happens when the field on on the website-specific
view was not edited.
</p>

<p>
When views are rendered <a href="https://github.com/odoo/odoo/blob/dd40fb63b4ebdd4dd7b44c75d415e99b52d633a1/addons/website/models/ir_ui_view.py#L205">filter_duplicate()</a> ensures that for each <code>key</code>
a website specific view is preferred over a generic one if it exists.
</p>
</div>
</div>

<div id="outline-container-org41ff0bf" class="outline-3">
<h3 id="org41ff0bf"><span class="section-number-3">1.4</span> Mixins</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Multiple mixins are available to publish models on the website:
</p>
</div>

<div id="outline-container-orgfa94413" class="outline-4">
<h4 id="orgfa94413"><span class="section-number-4">1.4.1</span> website.published.multi.mixin</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
This inherits both <code>website.published.mixin</code> and <code>website.multi.mixin</code>
and is probably what you want to use in most cases. It allows records
in a model to be published on all or one website. When rendering a
QWeb view on the website make sure to wrap it in <code>website.layout</code> and
set <code>main_object</code> in the rendering context. It should be the main
record you're rendering, the website module will use this record to
make the publish/unpublish work:
</p>


<figure>
<img src="/notes/revisioned/multi_website/published_unpublished-197a5a0926.png" alt="published_unpublished.png">

</figure>

<p>
Unfortunately you need to manually check in your controllers whether
or not the record is accessible from the current website. This mixin
provides <code>can_access_from_current_website()</code> for that:
</p>

<pre class="example">
from werkzeug.exceptions import NotFound
# ...
if not record.can_access_from_current_website():
    raise NotFound()
</pre>
</div>
</div>

<div id="outline-container-org549e86d" class="outline-4">
<h4 id="org549e86d"><span class="section-number-4">1.4.2</span> website.published.mixin</h4>
<div class="outline-text-4" id="text-1-4-2">
<p>
This makes it possible to publish/unpublish your model through
<code>website_publish_button()</code>. It only supports publishing your record on
all websites. Records using this will also be publishable from the
website via the toggle.
</p>
</div>
</div>

<div id="outline-container-org298924a" class="outline-4">
<h4 id="org298924a"><span class="section-number-4">1.4.3</span> website.multi.mixin</h4>
<div class="outline-text-4" id="text-1-4-3">
<p>
In practice this only provides a <code>website_id</code> field and the
<code>can_access_from_current_website</code> function.  Use this if you want to
restrict the visibility of records in a model to one specific website,
but you want to handle this manually via
<code>can_access_from_current_website()</code> in a controller manually and you
don't want users to be able to publish/unpublish these records
themselves via the frontend.
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.1 (<a href="https://orgmode.org">Org</a> mode 9.1.9)</p><p class="author">Author: Joren Van Onder</p>
</div>
</body>
</html>
